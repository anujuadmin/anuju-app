# codemagic.yaml - PRODUCTION CONFIGURATION FOR ANUJU APP
# Save this file in your project root: C:\Users\Howard\Desktop\Anuju-IOS\anuju\codemagic.yaml

workflows:
  anuju-ios-production:
    name: Anuju iOS Production Build
    # This workflow will trigger on pushes to main branch
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
    
    environment:
      # You MUST set up these groups in Codemagic UI:
      # 1. appstore_credentials (for signing)
      # 2. environment_variables (optional, for secrets)
      groups:
        - appstore_credentials  # REQUIRED - set this up in Codemagic
      
      vars:
        BUNDLE_ID: "com.anuju.app"
        APP_NAME: "Anuju"
        APP_VERSION: "1.0.0"
        BUILD_NUMBER: "1"
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
      
      # iOS code signing configuration
      ios_signing:
        distribution_type: app_store  # For App Store submission
        bundle_identifier: $BUNDLE_ID
    
    scripts:
      # ========== PHASE 1: SETUP ==========
      - name: Setup and Dependencies
        script: |
          echo "ðŸš€ Starting Anuju iOS Production Build"
          echo "ðŸ“± Bundle ID: $BUNDLE_ID"
          echo "ðŸ·ï¸  Version: $APP_VERSION ($BUILD_NUMBER)"
          
          # Print Flutter info
          flutter --version
          
          # Get Flutter dependencies
          flutter pub get
          
          # Install iOS CocoaPods dependencies
          cd ios
          pod install
          cd ..
      
      # ========== PHASE 2: CONFIGURE iOS ==========
      - name: Configure iOS App
        script: |
          echo "âš™ï¸ Configuring iOS app metadata..."
          
          # Navigate to iOS directory
          cd ios
          
          # Update Info.plist with our values
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $APP_NAME" Runner/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $APP_VERSION" Runner/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" Runner/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $BUNDLE_ID" Runner/Info.plist
          
          # Enable WebView and allow HTTP loads
          /usr/libexec/PlistBuddy -c "Add :io.flutter.embedded_views_preview bool true" Runner/Info.plist 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :NSAppTransportSecurity dict" Runner/Info.plist 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :NSAppTransportSecurity:NSAllowsArbitraryLoads bool true" Runner/Info.plist 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :NSAppTransportSecurity:NSAllowsArbitraryLoadsInWebContent bool true" Runner/Info.plist 2>/dev/null || true
          
          echo "âœ… iOS configuration complete"
          cd ..
      
      # ========== PHASE 3: BUILD IPA ==========
      - name: Build iOS IPA
        script: |
          echo "ðŸ”¨ Building iOS IPA for App Store..."
          
          # Clean previous builds
          flutter clean
          
          # Build IPA with App Store export method
          flutter build ipa \
            --release \
            --export-method app-store \
            --dart-define=APP_NAME=$APP_NAME \
            --dart-define=APP_VERSION=$APP_VERSION \
            --dart-define=BUNDLE_ID=$BUNDLE_ID \
            --no-tree-shake-icons
          
          echo "âœ… IPA build completed"
          
          # Verify IPA was created
          if [ -f "build/ios/ipa/Runner.ipa" ]; then
            IPA_SIZE=$(du -h "build/ios/ipa/Runner.ipa" | cut -f1)
            echo "ðŸ“¦ IPA created: build/ios/ipa/Runner.ipa ($IPA_SIZE)"
            
            # Rename to Anuju.ipa
            mv "build/ios/ipa/Runner.ipa" "build/ios/ipa/Anuju.ipa"
            echo "ðŸ”„ Renamed to: build/ios/ipa/Anuju.ipa"
          else
            echo "âŒ IPA not found at build/ios/ipa/Runner.ipa"
            echo "ðŸ“ Checking for alternative locations..."
            find build/ios -name "*.ipa" -type f || echo "No IPA files found"
            exit 1
          fi
      
      # ========== PHASE 4: CREATE APP STORE METADATA ==========
      - name: Prepare App Store Metadata
        script: |
          echo "ðŸ“‹ Preparing App Store metadata..."
          
          # Create a metadata file with build info
          cat > build_info.md << EOF
          # Anuju iOS Build Information
          
          - **App Name**: $APP_NAME
          - **Version**: $APP_VERSION
          - **Build Number**: $BUILD_NUMBER
          - **Bundle ID**: $BUNDLE_ID
          - **Build Date**: $(date)
          - **Build Type**: App Store Release
          
          ## What's Included:
          âœ“ Flutter WebView application
          âœ“ Loads https://anuju.com
          âœ“ iOS 12.0+ support
          âœ“ iPhone & iPad support
          
          ## File Location:
          \`build/ios/ipa/Anuju.ipa\`
          
          ## Next Steps:
          1. Download this IPA file
          2. Go to App Store Connect
          3. Create new app version
          4. Upload this IPA
          5. Submit for review
          EOF
          
          echo "âœ… Metadata prepared"
    
    # ========== ARTIFACTS ==========
    # These files will be available for download
    artifacts:
      - build/ios/ipa/Anuju.ipa
      - build_info.md
      - flutter_drive.log
    
    # ========== PUBLISHING ==========
    publishing:
      # COMMENTED OUT: Auto-upload to App Store Connect
      # To enable later, remove the comment marks (#) and configure credentials
      #
      # app_store_connect:
      #   api_key: $APP_STORE_CONNECT_PRIVATE_KEY
      #   key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
      #   issuer_id: $APP_STORE_CONNECT_ISSUER_ID
      #   
      #   # Upload to TestFlight for testing
      #   submit_to_testflight: true
      #   
      #   # Release notes for TestFlight
      #   release_notes:
      #     'en-US': |
      #       ðŸš€ Anuju Travel App - Version $APP_VERSION
      #       
      #       â€¢ Book flights, hotels, and cars in one app
      #       â€¢ Compare prices across hundreds of providers
      #       â€¢ Secure booking with instant confirmation
      #       â€¢ Mobile-exclusive deals and discounts
      #       
      #       Your feedback helps us improve! Share your experience.
      
      # Email notification (keep this enabled)
      email:
        recipients:
          - admin@anuju.com  # CHANGE THIS TO YOUR EMAIL
        notify:
          success: true
          failure: true
      
      scripts:
        - name: Final Build Summary
          script: |
            echo ""
            echo "ðŸŽ‰ ANUJU iOS BUILD SUCCESSFUL ðŸŽ‰"
            echo "================================="
            echo "ðŸ“± App: $APP_NAME"
            echo "ðŸ”¢ Version: $APP_VERSION ($BUILD_NUMBER)"
            echo "ðŸ“¦ Bundle ID: $BUNDLE_ID"
            echo ""
            echo "â¬‡ï¸ IPA FILE READY FOR DOWNLOAD"
            echo "=============================="
            echo ""
            echo "ðŸ“ Location: build/ios/ipa/Anuju.ipa"
            echo "ðŸ“ Size: $(du -h build/ios/ipa/Anuju.ipa | cut -f1)"
            echo ""
            echo "ðŸ“¤ MANUAL UPLOAD INSTRUCTIONS:"
            echo "1. Go to https://appstoreconnect.apple.com"
            echo "2. Create new app 'Anuju' (if not exists)"
            echo "3. Go to TestFlight â†’ iOS"
            echo "4. Click '+' â†’ New Version"
            echo "5. Upload 'Anuju.ipa' file"
            echo "6. Complete metadata and submit"
            echo ""
            echo "âœ… Build complete! Download IPA from Artifacts section."